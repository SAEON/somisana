version = 0.1
default-task = 'start'
extensions = ['chomp@0.1:jspm', 'chomp@0.1:swc']

############################# 
#############################
#############################

[[task]]
name = 'start'
serial = true
deps = ['.cache', '.cache/*.html', 'copy-static-files', 'server']

#############################
#############################
#############################

[[task]]
name = 'copy-static-files'
run = """
cp -r public/* .cache/
"""

[[task]]
name = 'server'
env = { TZ='UTC', NODE_ENV='development', NODE_LOADER_CONFIG='loaders/config.js' }
serial = true
deps = ['server/ssr/index.js', 'node.importmap']
run = """
prettier \
  --ignore-path ../.prettierignore \
  --write "server/**/*.@(js|json|geojson|cjs|mjs|graphql|ts|tsx|jsx)" \
  --write "loaders/**/*.js"
node --trace-warnings --experimental-loader @node-loader/core server
"""

[[task]]
name = 'rollup:ssr'
target = 'server/ssr/#.js'
dep = 'server/ssr/src/#.jsx'
run = 'rollup -c rollup/server.config.js'

############################# 
#############################
#############################

# Create an import map for node
[[task]]
name = 'jspm:node'
deps = ['index.importmap.js', '.cache']
target = 'node.importmap'
template = 'jspm'
[task.template-options]
default-provider = 'jspm'
env = ['node', 'development', 'module']
ignore = [
  'graphql',
  'apollo-server-core',
  'apollo-server-koa',
  'koa-bodyparser',
  'node-fetch'
]

# Transpile HTML + js => HTML / import map
[[task]]
name = 'jspm:client'
deps = ['client/html/#.html', '.cache']
target = '.cache/#.html'
template = 'jspm'
[task.template-options]
env = ['browser', 'development', 'module']
default-provider = 'jspm'
preload = true
integrity = true

[[task]]
target = '.cache'
dep = 'client/**/*'
run = """
rollup --config rollup/client.config.js
"""

# First delete and recreate the cache
[[task]]
name = 'clear-cache'
run = """
rimraf node.importmap
rimraf .cache
rimraf server/ssr/*.js
"""

############################# 
#############################
#############################

# [[task]]
# name = 'prettier'
# dep = 'client/**/*.js'
# run = 'prettier --ignore-path ../.prettierignore --write "${{changed}}"'

[[task]]
name = 'prettier'
run = """
prettier \
  --ignore-path ../.prettierignore \
  --write "client/**/*.@(js|jsx|json|mjs|cjs|graphql|yml|ts|tsx)" \
  --write "common/**/*.@(js|jsx|json|mjs|cjs|graphql|yml|ts|tsx)" \
  --write "server/**/*.@(js|json|geojson|cjs|mjs|graphql)" \
  --write "loaders/**/*.js" \
  --write "rollup/**/*.js" \
  --write "./*.@(js|jsx|json|mjs|cjs|graphql|yml)"
"""

# DEPENDENCY MANAGEMNT

[[task]]
name = 'reset'
run = 'find . -name node_modules -type d -exec rm -rv {} + && find . -name package-lock.json -type f -delete'

[[task]]
name = 'ncu'
run = 'ncu'

[[task]]
name = 'ncu:u'
run = """
ncu -u
npm install
"""

