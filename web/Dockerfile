# CLIENT

ARG NODE_ENV
ARG REACT_APP_API_ADDRESS
ARG REACT_APP_ESRI_API_KEY
ARG REACT_APP_HOSTNAME
ARG REACT_APP_TECHNICAL_CONTACT
ARG REACT_APP_TILESERV_BASE_URL

FROM node:20.4.0-alpine as client

WORKDIR /somisana-client

RUN echo "NODE_ENV=$NODE_ENV" > .env
RUN echo "REACT_APP_API_ADDRESS=$REACT_APP_API_ADDRESS" >> .env
RUN echo "REACT_APP_ESRI_API_KEY=$REACT_APP_ESRI_API_KEY" >> .env
RUN echo "REACT_APP_HOSTNAME=$REACT_APP_HOSTNAME" >> .env
RUN echo "REACT_APP_TECHNICAL_CONTACT=$REACT_APP_TECHNICAL_CONTACT" >> .env
RUN echo "REACT_APP_TILESERV_BASE_URL=$REACT_APP_TILESERV_BASE_URL" >> .env

COPY client .
RUN npm install -g chomp@0.2.17 & npm ci --omit=dev
RUN npm run build


# API
FROM node:20.4.0-alpine

ARG ALLOWED_ORIGINS
ARG DEPLOYMENT_ENV
ARG HOSTNAME
ARG KEY
ARG MONGO_DB
ARG MONGO_HOST
ARG MONGO_PASSWORD
ARG MONGO_USERNAME
ARG NODE_ENV
ARG ODP_HOSTNAME
ARG ODP_SSO_CLIENT_ID
ARG ODP_SSO_CLIENT_REDIRECT
ARG ODP_SSO_CLIENT_SCOPES
ARG ODP_SSO_CLIENT_SECRET
ARG PASSPORT_SSO_SESSION_ID
ARG PG_DB
ARG PG_HOST
ARG PG_PASSWORD
ARG PG_PORT
ARG PG_USERNAME
ARG PORT

ENV ALLOWED_ORIGINS=$ALLOWED_ORIGINS
ENV DEPLOYMENT_ENV=$DEPLOYMENT_ENV
ENV HOSTNAME=$HOSTNAME
ENV KEY=$KEY
ENV MONGO_DB=$MONGO_DB
ENV MONGO_HOST=$MONGO_HOST
ENV MONGO_PASSWORD=$MONGO_PASSWORD
ENV MONGO_USERNAME=$MONGO_USERNAME
ENV NODE_ENV=$NODE_ENV
ENV ODP_HOSTNAME=$ODP_HOSTNAME
ENV ODP_SSO_CLIENT_ID=$ODP_SSO_CLIENT_ID
ENV ODP_SSO_CLIENT_REDIRECT=$ODP_SSO_CLIENT_REDIRECT
ENV ODP_SSO_CLIENT_SCOPES=$ODP_SSO_CLIENT_SCOPES
ENV ODP_SSO_CLIENT_SECRET=$ODP_SSO_CLIENT_SECRET
ENV PASSPORT_SSO_SESSION_ID=$PASSPORT_SSO_SESSION_ID
ENV PG_DB=$PG_DB
ENV PG_HOST=$PG_HOST
ENV PG_PASSWORD=$PG_PASSWORD
ENV PG_PORT=$PG_PORT
ENV PG_USERNAME=$PG_USERNAME
ENV PORT=$PORT



WORKDIR /app
COPY api .
COPY --from=client /somisana-client/build /app/client
RUN npm ci --omit=dev

EXPOSE 3000