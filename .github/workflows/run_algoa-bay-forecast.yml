name: Run Algoa Bay Forecast model

on:
  workflow_dispatch:
    inputs:
      run_date:
        description: Run date (default = today). yyyymmdd
        required: false
        default:
  schedule:
    - cron: '0 02 * * *' # 0400 SAST

env:
  REGISTRY: ghcr.io
  COPERNICUS_USERNAME: ${{ secrets.COPERNICUS_USERNAME }}
  COPERNICUS_PASSWORD: ${{ secrets.COPERNICUS_PASSWORD }}
  MLM_LICENSE_FILE: ${{ secrets.MLM_LICENSE_FILE }}
  MNEMOSYNE_TOKEN: ${{ secrets.MNEMOSYNE_TOKEN }}

jobs:
  # Dynamically set the branch ref to the currently executing branch
  branch-ref:
    runs-on: ubuntu-latest
    outputs:
      value: ${{ steps.BRANCH_REF.outputs.value }}
    steps:
      - name: Set the BRANCH_REF
        id: BRANCH_REF
        run: echo "value=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT

  # Many of the env variables reference the current branch
  # Set the environment variables using the current branch reference
  # (which is set dynamically)
  envs:
    needs: [branch-ref]
    runs-on: ubuntu-latest
    env:
      RUN_DATE: ${{ inputs.run_date }}
    outputs:
      BRANCH_REF: ${{ needs.branch-ref.outputs.value }}
      CROCO_IMAGE: ${{ steps.ENVS.outputs.CROCO_IMAGE }}
      TOOLKIT_IMAGE: ${{ steps.ENVS.outputs.TOOLKIT_IMAGE }}
      MODEL_RUN_DATE: ${{ steps.ENVS.outputs.MODEL_RUN_DATE }}
      RESTART_FILE_DATE: ${{ steps.ENVS.outputs.RESTART_FILE_DATE }}
    steps:
      - name: Configure run date
        id: run_date
        run: |
          echo "value=${RUN_DATE:=$(date +'%Y%m%d')}" >> $GITHUB_OUTPUT
      - name: Configure restart date
        id: restart_date
        run: |
          echo "value=$(date -d '${{ steps.run_date.outputs.value }} -1 days' +'%Y%m%d')" >> $GITHUB_OUTPUT
      - name: Set envs
        id: ENVS
        run: |
          echo "CROCO_IMAGE=${{ github.repository }}_algoa_bay_forecast_croco_${{ needs.branch-ref.outputs.value }}" >> $GITHUB_OUTPUT
          echo "TOOLKIT_IMAGE=${{ github.repository }}_toolkit_${{ needs.branch-ref.outputs.value }}" >> $GITHUB_OUTPUT
          echo "MODEL_RUN_DATE=${{ steps.run_date.outputs.value }}" >> $GITHUB_OUTPUT
          echo "RESTART_FILE_DATE=${{ steps.restart_date.outputs.value }}" >> $GITHUB_OUTPUT

  # Compile CROCO model for the Algoa Bay forecast
  compile-croco:
    needs: [envs]
    runs-on: ubuntu-latest
    env:
      BRANCH_REF: ${{ needs.envs.outputs.BRANCH_REF }}
      CROCO_IMAGE: ${{ needs.envs.outputs.CROCO_IMAGE }}
    outputs:
      image: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout source code
        uses: actions/checkout@master
        with:
          ref: ${{ env.BRANCH_REF }}
      - name: Log in to the Container registry
        uses: docker/login-action@master
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@master
        with:
          images: ${{ env.REGISTRY }}/${{ env.CROCO_IMAGE }}
          tags: |
            type=sha
      - name: Build and push
        uses: docker/build-push-action@master
        with:
          context: models/algoa-bay-forecast
          file: models/algoa-bay-forecast/croco.Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # The SOMISANA toolkit is a suite of scripts to facilitate
  # running SOMISANA models - for example the Algoa Bay Forecast.
  # In the context of a testing environment, where updates to these
  # scripts is part of the development workflow, the toolkit needs
  # to be compiled on every run
  toolkit:
    needs: [envs]
    runs-on: ubuntu-latest
    env:
      BRANCH_REF: ${{ needs.envs.outputs.BRANCH_REF }}
      TOOLKIT_IMAGE: ${{ needs.envs.outputs.TOOLKIT_IMAGE }}
      SHA: sha-${{ github.sha }}
    outputs:
      image: ${env.REGISTRY}/${{ steps.lowercase.outputs.image_name }}
    steps:
      - name: Get image name lowercase
        id: 'lowercase'
        run: |
          IMAGE_NAME_LOWER=$(echo $TOOLKIT_IMAGE | tr '[:upper:]' '[:lower:]')
          echo "image_name=$IMAGE_NAME_LOWER" >> $GITHUB_OUTPUT
      - name: Check out source code
        uses: actions/checkout@master
        with:
          ref: ${{ env.BRANCH_REF }}
      - name: Log in to the Container registry
        uses: docker/login-action@master
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Check if image with sha tag already exists
        id: check-image
        run: |
          set -e
          SHA_IMAGE=$(docker images -q ${REGISTRY}/${{ steps.lowercase.outputs.image_name }}:${SHA} || true)
          if [ -z "$SHA_IMAGE" ]; then
            echo "image_exists=false" >> $GITHUB_OUTPUT
          else
            echo "image_exists=true" >> $GITHUB_OUTPUT
          fi
      - name: Extract metadata (tags, labels) for Docker
        if: steps.check-image.outputs.image_exists == 'false'
        id: meta
        uses: docker/metadata-action@master
        with:
          images: ${{ env.REGISTRY }}/${{ env.TOOLKIT_IMAGE }}
          tags: |
            latest
            ${{ env.SHA }}
      - name: Build and push
        if: steps.check-image.outputs.image_exists == 'false'
        uses: docker/build-push-action@master
        with:
          context: toolkit
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # Create a tmp folder structure for mode run assets. The format is:
  ## YYYYMMDD/
  ##  - forcing-inputs/
  ##  - croco/
  ##     - forcing/
  ##     - forecast/
  ##     - scratch/
  workdir:
    needs: [envs]
    runs-on: somisana
    outputs:
      WORKDIR: ${{ steps.WORKDIR.outputs.WORKDIR}}
      WORKDIR_YESTERDAY: ${{ steps.WORKDIR.outputs.WORKDIR_YESTERDAY }}
    env:
      dirname: ${{ needs.envs.outputs.MODEL_RUN_DATE }}
      dirname_yesterday: ${{ needs.envs.outputs.RESTART_FILE_DATE }}
      branch_ref: ${{ needs.envs.outputs.BRANCH_REF }}
    steps:
      - name: Create /home/runner/somisana/algoa-bay-forecast/${{ env.branch_ref }}/${{ env.dirname }} directory structure
        run: |
          rm -rf /home/runner/somisana/algoa-bay-forecast/${{ env.branch_ref }}/${{ env.dirname }}
          mkdir -p /home/runner/somisana/algoa-bay-forecast/${{ env.branch_ref }}/${{ env.dirname }}/{croco/{forcing,forecast,scratch},forcing-inputs}
          chown -R :runners /home/runner/somisana/algoa-bay-forecast/${{ env.branch_ref }}/${{ env.dirname }}
          chmod -R 774 /home/runner/somisana/algoa-bay-forecast/${{ env.branch_ref }}/${{ env.dirname }}
      - name: Set WORKDIRs
        id: WORKDIR
        run: |
          echo "WORKDIR=/home/runner/somisana/algoa-bay-forecast/${{ env.branch_ref }}/${{ env.dirname }}" >> $GITHUB_OUTPUT
          echo "WORKDIR_YESTERDAY=/home/runner/somisana/algoa-bay-forecast/${{ env.branch_ref }}/${{ env.dirname_yesterday }}" >> $GITHUB_OUTPUT

  # Download environmental data used to constrain model boundaries.
  # This job is retried if it fails, since the failure can be due to upstream errors
  # These downloads are used to create forcing files that are fed as input to the CROCO model
  # => marine.copernicus.eu: This is ocean data that forms the boundary of our model run
  # => ncei.noaa.gov: This is weather data used to create sea-surface conditions for our model run
  boundary-data:
    needs: [toolkit, workdir, envs]
    runs-on: somisana
    env:
      WORKDIR: ${{ needs.workdir.outputs.WORKDIR }}
      MODEL_RUN_DATE: ${{ needs.envs.outputs.MODEL_RUN_DATE }}
      SHA: sha-${{ github.sha }}
    steps:
      - name: Source ~/.bashrc (for NVM - required for non-interactive shells)
        continue-on-error: true # Maybe Node.js exists anyway
        run: |
          source ~/.bashrc
          nvm use 19.6.0
      - name: Download GFS
        uses: nick-fields/retry@master
        with:
          timeout_minutes: 30 # Script is considered failed if this limit is reached
          retry_wait_seconds: 10 # Wait 10 minutes and try again
          max_attempts: 10
          retry_on: any
          warning_on_retry: true
          shell: bash
          continue_on_error: false
          on_retry_command: rm -f $WORKDIR/forcing-inputs/*grb*
          command: >-
            docker run \
              --rm \
              -v $WORKDIR/:/tmp/somisana/current \
              -e COPERNICUS_USERNAME=${{ env.COPERNICUS_USERNAME }} \
              -e COPERNICUS_PASSWORD=${{ env.COPERNICUS_PASSWORD }} \
              ${{ needs.toolkit.outputs.image }}:${{ env.SHA }} \
                ops \
                  download \
                    --provider gfs \
                    --workdir /tmp/somisana/current/forcing-inputs \
                    --matlab-env /tmp/somisana/current/.env \
                    --download-date ${{ env.MODEL_RUN_DATE }} \
                    --domain 22,31,-37,-31
      - name: Download Mercator
        uses: nick-fields/retry@master
        with:
          timeout_minutes: 30 # Script is considered failed if this limit is reached
          retry_wait_seconds: 10 # Wait 10 minutes and try again
          max_attempts: 10
          retry_on: any
          warning_on_retry: true
          shell: bash
          continue_on_error: false
          on_retry_command: rm -f $WORKDIR/forcing-inputs/*mercator*
          command: >-
            docker run \
              --rm \
              -v $WORKDIR/:/tmp/somisana/current \
              -e COPERNICUS_USERNAME=${{ env.COPERNICUS_USERNAME }} \
              -e COPERNICUS_PASSWORD=${{ env.COPERNICUS_PASSWORD }} \
              ${{ needs.toolkit.outputs.image }}:${{ env.SHA }} \
                ops \
                  download \
                    --provider mercator \
                    --workdir /tmp/somisana/current/forcing-inputs \
                    --matlab-env /tmp/somisana/current/.env \
                    --download-date ${{ env.MODEL_RUN_DATE }} \
                    --domain 22,31,-37,-31

  # CROCOTOOLS is a collection of MatLab scripts for converting environmental data (i.e. the boundary data downloaded previously)
  # into NetCDF files that can be used as input to the CROCO model. https://www.croco-ocean.org/documentation/crocotools-documentation/
  crocotools:
    needs: [boundary-data, workdir, envs]
    runs-on: somisana
    env:
      WORKDIR: ${{ needs.workdir.outputs.WORKDIR }}
      MODEL_RUN_DATE: ${{ needs.envs.outputs.MODEL_RUN_DATE }}
      RESTART_FILE_DATE: ${{ needs.envs.outputs.RESTART_FILE_DATE }}
      RESTART_FILE_PATH: ${{ needs.workdir.outputs.WORKDIR_YESTERDAY }}/croco/scratch/rst.nc
      BRANCH_REF: ${{ needs.envs.outputs.BRANCH_REF }}
    steps:
      - name: Check out source code
        uses: actions/checkout@master
        with:
          ref: ${{ env.BRANCH_REF }}
      - name: Copy yesterday's restart file (if it exists)
        run: cp ${{ env.RESTART_FILE_PATH }} ${{ env.WORKDIR }}/croco/forcing/rst_${{ env.RESTART_FILE_DATE }}.nc
        continue-on-error: true # Allow for the case where the restart file doesn't exist
      - name: Configure MatLab env restart file path
        run: echo "RESTART_FILE_PATH=/tmp/somisana/current/croco/forcing/rst_${{ env.RESTART_FILE_DATE }}.nc" >> ${{ env.WORKDIR }}/.env
      - name: Make forcing files
        run: >-
          docker run \
            --rm \
            -v $(pwd)/models/algoa-bay-forecast/crocotools:/crocotools/ \
            -v $(pwd)/models/algoa-bay-forecast/lib/grd.nc:/crocotools/croco/forcing/grd.nc \
            -v $WORKDIR:/tmp/somisana/current \
            -e MLM_LICENSE_FILE=${{ env.MLM_LICENSE_FILE }} \
            ghcr.io/saeon/somisana_matlab:r2022a \
              -batch "run('/crocotools/run.m')"

  # Execute the CROCO model using the forcing files created previously
  # The CROCO model executable is compiled a part of a Docker build, and is baked into a docker image.
  # As such the CROCO model run must be in the context of a container instantiated from that Docker image
  croco:
    needs: [compile-croco, crocotools, envs, workdir]
    runs-on: somisana
    env:
      WORKDIR: ${{ needs.workdir.outputs.WORKDIR }}
      BRANCH_REF: ${{ needs.envs.outputs.BRANCH_REF }}
      RUN_DATE: ${{ needs.envs.outputs.MODEL_RUN_DATE }}
    steps:
      - name: Check out source code
        uses: actions/checkout@master
        with:
          ref: ${{ env.BRANCH_REF }}
      - name: Execute CROCO binary
        run: >-
          docker run \
            --rm \
            -v $WORKDIR:/algoa-bay-forecast/current \
            -v $(pwd)/models/algoa-bay-forecast/lib/grd.nc:/algoa-bay-forecast/current/croco/forcing/grd.nc \
            --cpus 12 \
            ${{ needs.compile-croco.outputs.image }} \
              ./run_croco.bash \
                /algoa-bay-forecast/current \
                ${{ needs.envs.outputs.MODEL_RUN_DATE }} \
                ${{ needs.envs.outputs.RESTART_FILE_DATE }}
      - name: Move CROCO output
        run: mv ${{ env.WORKDIR }}/croco/scratch/avg.nc ${{ env.WORKDIR }}/croco/forecast/hourly-avg-${{ env.RUN_DATE }}.nc

  # Updates CROCO output vars to be centred
  # and work out depth levels in meters
  normalize-output:
    needs: [branch-ref, croco, toolkit, envs, workdir]
    runs-on: somisana
    env:
      WORKDIR: ${{ needs.workdir.outputs.WORKDIR }}
      RUN_DATE: ${{ needs.envs.outputs.MODEL_RUN_DATE }}
      SHA: sha-${{ github.sha }}
    steps:
      - name: Check out source code
        uses: actions/checkout@master
        with:
          ref: ${{ env.BRANCH_REF }}
      - name: Normalize the model output
        run: >-
          docker run \
            --rm \
            -v $WORKDIR:/tmp/somisana/current \
            -v $(pwd)/models/algoa-bay-forecast/lib/grd.nc:/tmp/somisana/current/croco/forcing/grd.nc \
            ${{ needs.toolkit.outputs.image }}:${{ env.SHA }} \
              ops \
                transform \
                  --grid-input-path /tmp/somisana/current/croco/forcing/grd.nc \
                  --nc-input-path /tmp/somisana/current/croco/forecast/hourly-avg-${{ env.RUN_DATE }}.nc \
                  --nc-output-path /tmp/somisana/current/croco/forecast/algoa-bay-forecast-${{ env.RUN_DATE }}.nc \
                  --zarr-output-path /tmp/somisana/current/croco/forecast/${{ env.RUN_DATE }}-hourly-avg-processed.zarr

  # Archive CROCO output
  archive-data:
    needs: [normalize-output, workdir, envs]
    runs-on: somisana
    env:
      WORKDIR: ${{ needs.workdir.outputs.WORKDIR }}
      RUN_DATE: ${{ needs.envs.outputs.MODEL_RUN_DATE }}
    steps:
      - name: Load $PATH
        run: |
          source ~/.bashrc
      - name: Upload raw CROCO NetCDF file to mnemosyne HTTP-range server
        continue-on-error: true
        run: |
          cat \
            ${{ env.WORKDIR }}/croco/forecast/hourly-avg-${{ env.RUN_DATE }}.nc \
              | curl \
                --silent \
                --keepalive-time 2400 \
                -X PUT \
                -H "Content-Type: application/octet-stream" \
                -H "Authorization: ${{ env.MNEMOSYNE_TOKEN }}" \
                -T \
                - \
                https://mnemosyne.somisana.ac.za/somisana/algoa-bay-forecast/${{ env.RUN_DATE }}-hourly-avg.nc;
      - name: Upload processed CROCO NetCDF file to mnemosyne HTTP-range server
        continue-on-error: true
        run: |
          cat \
            ${{ env.WORKDIR }}/croco/forecast/algoa-bay-forecast-${{ env.RUN_DATE }}.nc \
              | curl \
                --silent \
                --keepalive-time 2400 \
                -X PUT \
                -H "Content-Type: application/octet-stream" \
                -H "Authorization: ${{ env.MNEMOSYNE_TOKEN }}" \
                -T \
                - \
                https://mnemosyne.somisana.ac.za/somisana/algoa-bay-forecast/${{ env.RUN_DATE }}-hourly-avg-processed.nc;

  # Load raster data into postgis using raster2pgsql
  load-postgis:
    needs: [normalize-output, branch-ref, toolkit, envs, workdir]
    runs-on: somisana
    env:
      WORKDIR: ${{ needs.workdir.outputs.WORKDIR }}
      RUN_DATE: ${{ needs.envs.outputs.MODEL_RUN_DATE }}
      SHA: sha-${{ github.sha }}
    steps:
      - name: Get PG_HOST secret name
        id: _PG_HOST_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_HOST_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_PORT secret name
        id: _PG_PORT_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_PORT_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_DB secret name
        id: _PG_DB_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_DB_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_USERNAME secret name
        id: _PG_USERNAME_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_USERNAME_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_PASSWORD secret name
        id: _PG_PASSWORD_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_PASSWORD_${{ needs.branch-ref.outputs.value }}
      - name: Load normalized NetCDF output to PostGIS
        env:
          PG_HOST: ${{ secrets[steps._PG_HOST_.outputs.uppercase] }}
          PG_PORT: ${{ secrets[steps._PG_PORT_.outputs.uppercase] }}
          PG_DB: ${{ secrets[steps._PG_DB_.outputs.uppercase] }}
          PG_USERNAME: ${{ secrets[steps._PG_USERNAME_.outputs.uppercase] }}
          PG_PASSWORD: ${{ secrets[steps._PG_PASSWORD_.outputs.uppercase] }}
        run: >-
          docker run \
            --rm \
            -v $WORKDIR:/tmp/somisana/current \
            -e PG_HOST=$PG_HOST \
            -e PG_PORT=$PG_PORT \
            -e PG_USERNAME=$PG_USERNAME \
            -e PG_PASSWORD=$PG_PASSWORD \
            -e PG_DB=$PG_DB \
            ${{ needs.toolkit.outputs.image }}:${{ env.SHA }} \
              ops \
                load \
                  --upsert-rasters \
                  --upsert-coordinates \
                  --model-data /tmp/somisana/current/croco/forecast/algoa-bay-forecast-${{ env.RUN_DATE }}.nc \
                  --model algoa-bay-forecast \
                  --reload-data \
                  --run-date ${{ env.RUN_DATE }}

  # Refresh the values table with new data
  # Depth levels 1 - 3
  refresh-values-depths_1_3:
    needs: [load-postgis, branch-ref, toolkit, envs, workdir]
    runs-on: somisana
    env:
      WORKDIR: ${{ needs.workdir.outputs.WORKDIR }}
      RUN_DATE: ${{ needs.envs.outputs.MODEL_RUN_DATE }}
      SHA: sha-${{ github.sha }}
    steps:
      - name: Get PG_HOST secret name
        id: _PG_HOST_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_HOST_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_PORT secret name
        id: _PG_PORT_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_PORT_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_DB secret name
        id: _PG_DB_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_DB_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_USERNAME secret name
        id: _PG_USERNAME_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_USERNAME_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_PASSWORD secret name
        id: _PG_PASSWORD_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_PASSWORD_${{ needs.branch-ref.outputs.value }}
      - name: Load normalized NetCDF output to PostGIS
        env:
          PG_HOST: ${{ secrets[steps._PG_HOST_.outputs.uppercase] }}
          PG_PORT: ${{ secrets[steps._PG_PORT_.outputs.uppercase] }}
          PG_DB: ${{ secrets[steps._PG_DB_.outputs.uppercase] }}
          PG_USERNAME: ${{ secrets[steps._PG_USERNAME_.outputs.uppercase] }}
          PG_PASSWORD: ${{ secrets[steps._PG_PASSWORD_.outputs.uppercase] }}
        run: >-
          docker run \
            --rm \
            -v $WORKDIR:/tmp/somisana/current \
            -e PG_HOST=$PG_HOST \
            -e PG_PORT=$PG_PORT \
            -e PG_USERNAME=$PG_USERNAME \
            -e PG_PASSWORD=$PG_PASSWORD \
            -e PG_DB=$PG_DB \
            ${{ needs.toolkit.outputs.image }}:${{ env.SHA }} \
              ops \
                load \
                  --upsert-values \
                  --depths 1,3 \
                  --model algoa-bay-forecast \
                  --model-data /tmp/somisana/current/croco/forecast/algoa-bay-forecast-${{ env.RUN_DATE }}.nc \
                  --run-date ${{ env.RUN_DATE }}

  # Refresh the values table with new data
  # Depth levels 4 - 6
  refresh-values-depths_4_6:
    needs: [load-postgis, branch-ref, toolkit, envs, workdir]
    runs-on: somisana
    env:
      WORKDIR: ${{ needs.workdir.outputs.WORKDIR }}
      RUN_DATE: ${{ needs.envs.outputs.MODEL_RUN_DATE }}
      SHA: sha-${{ github.sha }}
    steps:
      - name: Get PG_HOST secret name
        id: _PG_HOST_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_HOST_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_PORT secret name
        id: _PG_PORT_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_PORT_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_DB secret name
        id: _PG_DB_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_DB_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_USERNAME secret name
        id: _PG_USERNAME_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_USERNAME_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_PASSWORD secret name
        id: _PG_PASSWORD_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_PASSWORD_${{ needs.branch-ref.outputs.value }}
      - name: Load normalized NetCDF output to PostGIS
        env:
          PG_HOST: ${{ secrets[steps._PG_HOST_.outputs.uppercase] }}
          PG_PORT: ${{ secrets[steps._PG_PORT_.outputs.uppercase] }}
          PG_DB: ${{ secrets[steps._PG_DB_.outputs.uppercase] }}
          PG_USERNAME: ${{ secrets[steps._PG_USERNAME_.outputs.uppercase] }}
          PG_PASSWORD: ${{ secrets[steps._PG_PASSWORD_.outputs.uppercase] }}
        run: >-
          docker run \
            --rm \
            -v $WORKDIR:/tmp/somisana/current \
            -e PG_HOST=$PG_HOST \
            -e PG_PORT=$PG_PORT \
            -e PG_USERNAME=$PG_USERNAME \
            -e PG_PASSWORD=$PG_PASSWORD \
            -e PG_DB=$PG_DB \
            ${{ needs.toolkit.outputs.image }}:${{ env.SHA }} \
              ops \
                load \
                  --upsert-values \
                  --depths 4,6 \
                  --model algoa-bay-forecast \
                  --model-data /tmp/somisana/current/croco/forecast/algoa-bay-forecast-${{ env.RUN_DATE }}.nc \
                  --run-date ${{ env.RUN_DATE }}

  # Refresh the values table with new data
  # Depth levels 7 - 9
  refresh-values-depths_7_9:
    needs: [load-postgis, branch-ref, toolkit, envs, workdir]
    runs-on: somisana
    env:
      WORKDIR: ${{ needs.workdir.outputs.WORKDIR }}
      RUN_DATE: ${{ needs.envs.outputs.MODEL_RUN_DATE }}
      SHA: sha-${{ github.sha }}
    steps:
      - name: Get PG_HOST secret name
        id: _PG_HOST_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_HOST_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_PORT secret name
        id: _PG_PORT_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_PORT_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_DB secret name
        id: _PG_DB_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_DB_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_USERNAME secret name
        id: _PG_USERNAME_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_USERNAME_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_PASSWORD secret name
        id: _PG_PASSWORD_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_PASSWORD_${{ needs.branch-ref.outputs.value }}
      - name: Load normalized NetCDF output to PostGIS
        env:
          PG_HOST: ${{ secrets[steps._PG_HOST_.outputs.uppercase] }}
          PG_PORT: ${{ secrets[steps._PG_PORT_.outputs.uppercase] }}
          PG_DB: ${{ secrets[steps._PG_DB_.outputs.uppercase] }}
          PG_USERNAME: ${{ secrets[steps._PG_USERNAME_.outputs.uppercase] }}
          PG_PASSWORD: ${{ secrets[steps._PG_PASSWORD_.outputs.uppercase] }}
        run: >-
          docker run \
            --rm \
            -v $WORKDIR:/tmp/somisana/current \
            -e PG_HOST=$PG_HOST \
            -e PG_PORT=$PG_PORT \
            -e PG_USERNAME=$PG_USERNAME \
            -e PG_PASSWORD=$PG_PASSWORD \
            -e PG_DB=$PG_DB \
            ${{ needs.toolkit.outputs.image }}:${{ env.SHA }} \
              ops \
                load \
                  --upsert-values \
                  --depths 7,9 \
                  --model algoa-bay-forecast \
                  --model-data /tmp/somisana/current/croco/forecast/algoa-bay-forecast-${{ env.RUN_DATE }}.nc \
                  --run-date ${{ env.RUN_DATE }}

  # Refresh the values table with new data
  # Depth levels 10 - 12
  refresh-values-depths_10_12:
    needs: [load-postgis, branch-ref, toolkit, envs, workdir]
    runs-on: somisana
    env:
      WORKDIR: ${{ needs.workdir.outputs.WORKDIR }}
      RUN_DATE: ${{ needs.envs.outputs.MODEL_RUN_DATE }}
      SHA: sha-${{ github.sha }}
    steps:
      - name: Get PG_HOST secret name
        id: _PG_HOST_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_HOST_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_PORT secret name
        id: _PG_PORT_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_PORT_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_DB secret name
        id: _PG_DB_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_DB_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_USERNAME secret name
        id: _PG_USERNAME_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_USERNAME_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_PASSWORD secret name
        id: _PG_PASSWORD_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_PASSWORD_${{ needs.branch-ref.outputs.value }}
      - name: Load normalized NetCDF output to PostGIS
        env:
          PG_HOST: ${{ secrets[steps._PG_HOST_.outputs.uppercase] }}
          PG_PORT: ${{ secrets[steps._PG_PORT_.outputs.uppercase] }}
          PG_DB: ${{ secrets[steps._PG_DB_.outputs.uppercase] }}
          PG_USERNAME: ${{ secrets[steps._PG_USERNAME_.outputs.uppercase] }}
          PG_PASSWORD: ${{ secrets[steps._PG_PASSWORD_.outputs.uppercase] }}
        run: >-
          docker run \
            --rm \
            -v $WORKDIR:/tmp/somisana/current \
            -e PG_HOST=$PG_HOST \
            -e PG_PORT=$PG_PORT \
            -e PG_USERNAME=$PG_USERNAME \
            -e PG_PASSWORD=$PG_PASSWORD \
            -e PG_DB=$PG_DB \
            ${{ needs.toolkit.outputs.image }}:${{ env.SHA }} \
              ops \
                load \
                  --upsert-values \
                  --depths 10,12 \
                  --model algoa-bay-forecast \
                  --model-data /tmp/somisana/current/croco/forecast/algoa-bay-forecast-${{ env.RUN_DATE }}.nc \
                  --run-date ${{ env.RUN_DATE }}

  # Refresh the values table with new data
  # Depth levels 13 - 15
  refresh-values-depths_13_15:
    needs: [load-postgis, branch-ref, toolkit, envs, workdir]
    runs-on: somisana
    env:
      WORKDIR: ${{ needs.workdir.outputs.WORKDIR }}
      RUN_DATE: ${{ needs.envs.outputs.MODEL_RUN_DATE }}
      SHA: sha-${{ github.sha }}
    steps:
      - name: Get PG_HOST secret name
        id: _PG_HOST_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_HOST_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_PORT secret name
        id: _PG_PORT_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_PORT_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_DB secret name
        id: _PG_DB_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_DB_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_USERNAME secret name
        id: _PG_USERNAME_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_USERNAME_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_PASSWORD secret name
        id: _PG_PASSWORD_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_PASSWORD_${{ needs.branch-ref.outputs.value }}
      - name: Load normalized NetCDF output to PostGIS
        env:
          PG_HOST: ${{ secrets[steps._PG_HOST_.outputs.uppercase] }}
          PG_PORT: ${{ secrets[steps._PG_PORT_.outputs.uppercase] }}
          PG_DB: ${{ secrets[steps._PG_DB_.outputs.uppercase] }}
          PG_USERNAME: ${{ secrets[steps._PG_USERNAME_.outputs.uppercase] }}
          PG_PASSWORD: ${{ secrets[steps._PG_PASSWORD_.outputs.uppercase] }}
        run: >-
          docker run \
            --rm \
            -v $WORKDIR:/tmp/somisana/current \
            -e PG_HOST=$PG_HOST \
            -e PG_PORT=$PG_PORT \
            -e PG_USERNAME=$PG_USERNAME \
            -e PG_PASSWORD=$PG_PASSWORD \
            -e PG_DB=$PG_DB \
            ${{ needs.toolkit.outputs.image }}:${{ env.SHA }} \
              ops \
                load \
                  --upsert-values \
                  --depths 13,15 \
                  --model algoa-bay-forecast \
                  --model-data /tmp/somisana/current/croco/forecast/algoa-bay-forecast-${{ env.RUN_DATE }}.nc \
                  --run-date ${{ env.RUN_DATE }}

  # Refresh the values table with new data
  # Depth levels 16 - 18
  refresh-values-depths_16_18:
    needs: [load-postgis, branch-ref, toolkit, envs, workdir]
    runs-on: somisana
    env:
      WORKDIR: ${{ needs.workdir.outputs.WORKDIR }}
      RUN_DATE: ${{ needs.envs.outputs.MODEL_RUN_DATE }}
      SHA: sha-${{ github.sha }}
    steps:
      - name: Get PG_HOST secret name
        id: _PG_HOST_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_HOST_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_PORT secret name
        id: _PG_PORT_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_PORT_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_DB secret name
        id: _PG_DB_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_DB_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_USERNAME secret name
        id: _PG_USERNAME_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_USERNAME_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_PASSWORD secret name
        id: _PG_PASSWORD_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_PASSWORD_${{ needs.branch-ref.outputs.value }}
      - name: Load normalized NetCDF output to PostGIS
        env:
          PG_HOST: ${{ secrets[steps._PG_HOST_.outputs.uppercase] }}
          PG_PORT: ${{ secrets[steps._PG_PORT_.outputs.uppercase] }}
          PG_DB: ${{ secrets[steps._PG_DB_.outputs.uppercase] }}
          PG_USERNAME: ${{ secrets[steps._PG_USERNAME_.outputs.uppercase] }}
          PG_PASSWORD: ${{ secrets[steps._PG_PASSWORD_.outputs.uppercase] }}
        run: >-
          docker run \
            --rm \
            -v $WORKDIR:/tmp/somisana/current \
            -e PG_HOST=$PG_HOST \
            -e PG_PORT=$PG_PORT \
            -e PG_USERNAME=$PG_USERNAME \
            -e PG_PASSWORD=$PG_PASSWORD \
            -e PG_DB=$PG_DB \
            ${{ needs.toolkit.outputs.image }}:${{ env.SHA }} \
              ops \
                load \
                  --upsert-values \
                  --depths 16,18 \
                  --model algoa-bay-forecast \
                  --model-data /tmp/somisana/current/croco/forecast/algoa-bay-forecast-${{ env.RUN_DATE }}.nc \
                  --run-date ${{ env.RUN_DATE }}

  # Refresh the values table with new data
  # Depth levels 19 - 20
  refresh-values-depths_19_20:
    needs: [load-postgis, branch-ref, toolkit, envs, workdir]
    runs-on: somisana
    env:
      WORKDIR: ${{ needs.workdir.outputs.WORKDIR }}
      RUN_DATE: ${{ needs.envs.outputs.MODEL_RUN_DATE }}
      SHA: sha-${{ github.sha }}
    steps:
      - name: Get PG_HOST secret name
        id: _PG_HOST_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_HOST_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_PORT secret name
        id: _PG_PORT_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_PORT_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_DB secret name
        id: _PG_DB_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_DB_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_USERNAME secret name
        id: _PG_USERNAME_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_USERNAME_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_PASSWORD secret name
        id: _PG_PASSWORD_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_PASSWORD_${{ needs.branch-ref.outputs.value }}
      - name: Load normalized NetCDF output to PostGIS
        env:
          PG_HOST: ${{ secrets[steps._PG_HOST_.outputs.uppercase] }}
          PG_PORT: ${{ secrets[steps._PG_PORT_.outputs.uppercase] }}
          PG_DB: ${{ secrets[steps._PG_DB_.outputs.uppercase] }}
          PG_USERNAME: ${{ secrets[steps._PG_USERNAME_.outputs.uppercase] }}
          PG_PASSWORD: ${{ secrets[steps._PG_PASSWORD_.outputs.uppercase] }}
        run: >-
          docker run \
            --rm \
            -v $WORKDIR:/tmp/somisana/current \
            -e PG_HOST=$PG_HOST \
            -e PG_PORT=$PG_PORT \
            -e PG_USERNAME=$PG_USERNAME \
            -e PG_PASSWORD=$PG_PASSWORD \
            -e PG_DB=$PG_DB \
            ${{ needs.toolkit.outputs.image }}:${{ env.SHA }} \
              ops \
                load \
                  --upsert-values \
                  --depths 19,20 \
                  --model algoa-bay-forecast \
                  --model-data /tmp/somisana/current/croco/forecast/algoa-bay-forecast-${{ env.RUN_DATE }}.nc \
                  --run-date ${{ env.RUN_DATE }}

  gather-jobs:
    needs:
      [
        refresh-values-depths_1_3,
        refresh-values-depths_4_6,
        refresh-values-depths_7_9,
        refresh-values-depths_10_12,
        refresh-values-depths_13_15,
        refresh-values-depths_16_18,
        refresh-values-depths_19_20,
      ]
    runs-on: somisana
    steps:
      - name: noop
        run: echo done

  # Cleanup old runs temp files
  cleanup-temp-files:
    needs: [gather-jobs, branch-ref]
    runs-on: somisana
    env:
      BRANCH: ${{ needs.branch-ref.outputs.value }}
    steps:
      - name: Clean /home/runner/somisana/algoa-bay-forecast/${{ env.BRANCH }}
        run: >-
          find \
            /home/runner/somisana/algoa-bay-forecast/${{ env.BRANCH }}/* \
            -maxdepth 0 \
            -type d \
            -ctime +10 \
            -exec \
              rm \
                -rf {} \;

  # Cleanup rasters, and mark run as complete
  finalize-run:
    needs: [branch-ref, toolkit, gather-jobs]
    runs-on: somisana
    env:
      SHA: sha-${{ github.sha }}
    steps:
      - name: Get PG_HOST secret name
        id: _PG_HOST_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_HOST_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_PORT secret name
        id: _PG_PORT_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_PORT_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_DB secret name
        id: _PG_DB_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_DB_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_USERNAME secret name
        id: _PG_USERNAME_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_USERNAME_${{ needs.branch-ref.outputs.value }}
      - name: Get PG_PASSWORD secret name
        id: _PG_PASSWORD_
        uses: ASzc/change-string-case-action@master
        with:
          string: PG_PASSWORD_${{ needs.branch-ref.outputs.value }}
      - name: Cleanup rasters that have been loaded into values table and mark run as complete
        env:
          PG_HOST: ${{ secrets[steps._PG_HOST_.outputs.uppercase] }}
          PG_PORT: ${{ secrets[steps._PG_PORT_.outputs.uppercase] }}
          PG_DB: ${{ secrets[steps._PG_DB_.outputs.uppercase] }}
          PG_USERNAME: ${{ secrets[steps._PG_USERNAME_.outputs.uppercase] }}
          PG_PASSWORD: ${{ secrets[steps._PG_PASSWORD_.outputs.uppercase] }}
        run: >-
          docker run \
            --rm \
            -e PG_HOST=$PG_HOST \
            -e PG_PORT=$PG_PORT \
            -e PG_USERNAME=$PG_USERNAME \
            -e PG_PASSWORD=$PG_PASSWORD \
            -e PG_DB=$PG_DB \
            ${{ needs.toolkit.outputs.image }}:${{ env.SHA }} \
              ops \
                load \
                  --finalize-run \
                  --model algoa-bay-forecast
